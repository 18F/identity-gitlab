---
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  name: gitlab
  namespace: flux-system
spec:
  interval: 1m
  url: https://charts.gitlab.io/

---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitlab
  namespace: gitlab
spec:
  interval: 5m
  chart:
    spec:
      chart: gitlab
      version: "4.12.4"
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
      interval: 1m
  values:
    nginx-ingress:
      controller:
        scope:
          enabled: true
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                    - gitlab-nginx
                  - key: app.kubernetes.io/instance
                    operator: In
                    values:
                    - gitlab-nginx
                  - key: app.kubernetes.io/component
                    operator: In
                    values:
                    - controller
                topologyKey: kubernetes.io/hostname
        service:
          externalTrafficPolicy: Cluster
          enableHttp: false
          targetPorts:
            https: http
          annotations:
            service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: Name=gitlab-nginx,class=nginx,role=test,vpc=test
            service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0
            service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: "*"
            service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
            service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
        config:
          use-forwarded-headers: "true"
          client-header-timeout: "420"
          proxy-stream-timeout: "200s"
          client-body-timeout: "420"
        headers:
          X-Forwarded-Ssl: "on"
        stats:
          enabled: true
        metrics:
          enabled: true
      podSecurityPolicy:
        enabled: true
      serviceAccount:
        create: true
    certmanager:
      install: false
    global:
      ingress:
        enabled: false
        configureCertmanager: false
        tls:
          enabled: false
      psql:
        password:
          secret: rds-pw-gitlab
          key: password
      redis:
        scheme: rediss
        password:
          secret: rds-pw-gitlab
          key: redispw
      email:
        display_name: "Login.gov GitLab"
      smtp:
        enabled: true
        starttls_auto: true
        port: 587
        authentication: login
        password:
          secret: ses-smtp
          key: password
      minio:
        enabled: false
      appConfig:
        object_store:
          # connection:
          #   provider: AWS
          #   use_iam_profile: true
          enabled: true
          storage_options:
            server_side_encryption: "AES256"
    postgresql:
      install: false
    redis:
      install: false
  valuesFrom:
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: cluster_name
      targetPath: clusterName
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: domain
      targetPath: global.hosts.domain
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: cluster_name
      targetPath: global.hosts.hostSuffix
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: fullhostname
      targetPath: global.hosts.gitlab.hostnameOverride
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: certmanager-issuer-email
      targetPath: certmanager-issuer.email
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: pghost
      targetPath: global.psql.host
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: pgport
      targetPath: global.psql.port
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: redisport
      targetPath: global.redis.port
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: redishost
      targetPath: global.redis.host
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: ingress-security-groups
      targetPath: nginx-ingress.controller.service.annotations.service\.beta\.kubernetes\.io/aws-load-balancer-security-groups
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: cert-arn
      targetPath: nginx-ingress.controller.service.annotations.service\.beta\.kubernetes\.io/aws-load-balancer-ssl-cert
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: email-from
      targetPath: global.email.from
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: smtp-endpoint
      targetPath: global.smtp.address
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: email-domain
      targetPath: global.smtp.domain
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: smtp-username
      targetPath: global.smtp.user_name

    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: artifactsbucket
      targetPath: global.appConfig.artifacts.bucket
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: lfsbucket
      targetPath: global.appConfig.lfs.bucket
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: packagesbucket
      targetPath: global.appConfig.packages.bucket
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: uploadsbucket
      targetPath: global.appConfig.uploads.bucket
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: externalDiffsbucket
      targetPath: global.appConfig.externalDiffs.bucket
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: terraformStatebucket
      targetPath: global.appConfig.terraformState.bucket
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: dependencyProxybucket
      targetPath: global.appConfig.dependencyProxy.bucket
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: gitlabrolearn
      targetPath: global.serviceAccount.annotations.eks\.amazonaws\.com/role-arn
    - kind: ConfigMap
      name: terraform-gitlab-info
      valuesKey: region
      targetPath: global.appConfig.object_store.connection.region
